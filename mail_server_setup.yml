---
- name: Ensure that we have mail server packages installed
  apt: "name={{ item }} state=present"
  loop:
    - postfix
    - dovecot-imapd
    - dovecot-pop3d
    - dovecot-lmtpd
    - opendkim
    - opendkim-tools
    - spamass-milter

- name: Ensure that mail system servers are running and start at boot
  service: "name={{ item }} state=started enabled=yes"
  loop:
    - postfix
    - dovecot
    - spamassassin
    - spamass-milter

- name: Ensure that mailname is set to the hostname
  template:
    src: templates/etc_mailname.j2
    dest: /etc/mailname

- name: Configure postfix
  include_tasks: configure_postfix.yml
  tags:
    - postfix

- name: Configure dovecot
  include_tasks: configure_dovecot.yml
  tags:
    - dovecot

- name: Configure spamassasin
  include_tasks: configure_spamassassin.yml
  tags:
    - spamassassin

- name: Configure DKIM
  include_tasks: configure_dkim.yml
  tags:
    - dkim

- name: Create admin user for administrative emails
  user: name=admin create_home=yes

- name: Redirect mail meant for root to admin user
  lineinfile:
    dest: "/etc/aliases"
    regexp: "^root:"
    line: "root: admin"
    state: present
  notify: update aliases db
